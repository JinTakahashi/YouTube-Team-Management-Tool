<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>動画登録＆表示テスト</title>
</head>
<body>
  <h1>動画登録</h1>
  <form id="videoForm">
    <label for="video_id">Video ID:</label>
    <input type="text" id="video_id" name="video_id" required>
    <br>
    <label for="assignee">担当者:</label>
    <input type="text" id="assignee" name="assignee" required>
    <br>
    <button type="submit">登録する</button>
  </form>

  <h1>登録済み動画一覧</h1>
  <div id="videoList">読み込み中...</div>

  <script>
    const apiBase = "http://127.0.0.1:8000";

    // 登録済み動画一覧を取得
    async function fetchVideos() {
      try {
        alert("送信成功")
        const response = await fetch(`${apiBase}/videos`);
        const data = await response.json();
        const videoListDiv = document.getElementById("videoList");
        if (data.videos.length === 0) {
          videoListDiv.innerHTML = "登録されている動画はありません";
          return;
        }
        videoListDiv.innerHTML = "";
        data.videos.forEach(video => {
          const div = document.createElement("div");
          div.innerHTML = `<strong>${video.title}</strong> (${video.video_id})<br>
                           投稿日: ${video.published_at}<br>
                           視聴回数: ${video.views}<br>
                           チャンネル: ${video.channel_name}<br>
                           担当者: ${video.assignee}<hr>`;
          videoListDiv.appendChild(div);
        });
      } catch (error) {
        console.error("動画取得エラー:", error);
      }
    }

    // 初回ロード時に動画一覧を取得
    fetchVideos();

    // 登録フォームの送信処理
    document.getElementById("videoForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const videoId = document.getElementById("video_id").value;
      const assignee = document.getElementById("assignee").value;

      try {
        const response = await fetch(`${apiBase}/video?video_id=${encodeURIComponent(videoId)}&assignee=${encodeURIComponent(assignee)}`, {
          method: "POST"
        });
        const result = await response.json();
        alert(result.message);
        // 登録後、一覧を再取得
        fetchVideos();
      } catch (error) {
        console.error("登録エラー:", error);
        alert("動画登録中にエラーが発生しました");
      }
    });
  </script>
</body>
</html>
